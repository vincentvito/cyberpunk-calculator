<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cyberpunk Scientific Calculator</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="A cyberpunk-themed scientific calculator with currency and unit conversion">
    <meta name="theme-color" content="#00e5ff">
    <link rel="manifest" href="manifest.json">

    <!-- iOS Specific Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CyberCalc">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- Android/Chrome -->
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(180deg, #050a12 0%, #080d18 50%, #050810 100%);
            font-family: 'Orbitron', sans-serif;
        }

        .calculator-wrapper {
            position: relative;
            padding: 4px;
            border-radius: 24px;
            background: linear-gradient(180deg, #00e5ff 0%, #00bcd4 50%, #00e5ff 100%);
            box-shadow:
                0 0 30px rgba(0, 229, 255, 0.4),
                0 0 60px rgba(0, 229, 255, 0.2),
                inset 0 0 30px rgba(0, 229, 255, 0.1);
        }

        .calculator {
            background: linear-gradient(180deg, #0d1520 0%, #0a1018 50%, #0d1520 100%);
            border-radius: 20px;
            padding: 20px;
            width: 380px;
            max-height: 100vh;
            overflow: hidden;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .traffic-lights {
            display: flex;
            gap: 8px;
        }

        .traffic-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .traffic-light.red { background: #ff5f57; }
        .traffic-light.yellow { background: #ffbd2e; }
        .traffic-light.green { background: #28ca42; }

        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-label {
            font-size: 0.75rem;
            color: #5a7a9a;
            font-weight: 500;
        }

        .mode-label.active {
            color: #00e5ff;
        }

        .toggle-switch {
            width: 50px;
            height: 26px;
            background: #0d1a2d;
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            border: 2px solid #00e5ff44;
        }

        .toggle-knob {
            width: 20px;
            height: 20px;
            background: linear-gradient(180deg, #ff0080 0%, #cc0066 100%);
            border-radius: 50%;
            position: absolute;
            top: 1px;
            transition: left 0.2s ease;
            box-shadow: 0 0 10px rgba(255, 0, 128, 0.5);
        }

        .toggle-knob.basic { left: 2px; }
        .toggle-knob.sci { left: 26px; }

        .display-container {
            position: relative;
            background: #050a10;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            min-height: 85px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        .display-container::before,
        .display-container::after,
        .corner-bl,
        .corner-br {
            content: '';
            position: absolute;
            width: 15px;
            height: 15px;
            border-color: #00e5ff;
            border-style: solid;
            filter: drop-shadow(0 0 4px #00e5ff);
        }

        .display-container::before {
            top: 8px;
            left: 8px;
            border-width: 2px 0 0 2px;
        }

        .display-container::after {
            top: 8px;
            right: 8px;
            border-width: 2px 2px 0 0;
        }

        .corner-bl {
            bottom: 8px;
            left: 8px;
            border-width: 0 0 2px 2px;
        }

        .corner-br {
            bottom: 8px;
            right: 8px;
            border-width: 0 2px 2px 0;
        }

        .expression {
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.9rem;
            color: #ffd180;
            text-align: right;
            min-height: 20px;
            word-break: break-all;
            line-height: 1.3;
        }

        .display {
            font-family: 'Share Tech Mono', monospace;
            font-size: 2.5rem;
            color: #00ff88;
            text-align: right;
            word-break: break-all;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.8), 0 0 40px rgba(0, 255, 136, 0.4);
            filter: drop-shadow(0 0 15px rgba(0, 255, 136, 0.6));
        }

        .cursor {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .btn {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 500;
            padding: 16px 10px;
            border: 1px solid;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            background: #0a1520;
        }

        /* Memory buttons - cyan */
        .btn-memory {
            color: #00e5ff;
            border-color: #00e5ff55;
            background: #0a1520;
        }

        .btn-memory:hover {
            background: #122030;
            border-color: #00e5ff;
        }

        .btn-memory:active {
            transform: scale(0.95);
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.7), 0 0 50px rgba(0, 229, 255, 0.5);
            border-color: #00e5ff;
        }

        /* Function buttons - orange */
        .btn-function {
            color: #ffb74d;
            border-color: #ffa72655;
            background: #0a1520;
        }

        .btn-function:hover {
            background: #122030;
            border-color: #ffa726;
        }

        .btn-function:active {
            transform: scale(0.95);
            box-shadow: 0 0 30px rgba(255, 167, 38, 0.7), 0 0 50px rgba(255, 167, 38, 0.5);
            border-color: #ffa726;
        }

        /* Number buttons - white/gray */
        .btn-number {
            color: #ffffff;
            border-color: #3a4a6a;
            background: #0c1825;
        }

        .btn-number:hover {
            background: #142535;
            border-color: #5a6a8a;
        }

        .btn-number:active {
            transform: scale(0.95);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.5), 0 0 50px rgba(255, 255, 255, 0.3);
            border-color: #ffffff;
        }

        /* Operator buttons - magenta/pink */
        .btn-operator {
            color: #ff4081;
            border-color: #ff408155;
            background: #0a1520;
        }

        .btn-operator:hover {
            background: #122030;
            border-color: #ff4081;
        }

        .btn-operator:active {
            transform: scale(0.95);
            box-shadow: 0 0 30px rgba(255, 64, 129, 0.7), 0 0 50px rgba(255, 64, 129, 0.5);
            border-color: #ff4081;
        }

        /* Clear buttons - red */
        .btn-clear {
            color: #ff5252;
            border-color: #ff5252;
            background: #1a0a0a;
        }

        .btn-clear:hover {
            background: #2a1515;
        }

        .btn-clear:active {
            transform: scale(0.95);
            box-shadow: 0 0 30px rgba(255, 82, 82, 0.7), 0 0 50px rgba(255, 82, 82, 0.5);
            border-color: #ff5252;
        }

        /* ANS button - cyan accent */
        .btn-ans {
            color: #4dd0e1;
            border-color: #4dd0e155;
            background: #0a1520;
        }

        .btn-ans:hover {
            background: #122030;
            border-color: #4dd0e1;
        }

        .btn-ans:active {
            transform: scale(0.95);
            box-shadow: 0 0 30px rgba(77, 208, 225, 0.6), 0 0 50px rgba(77, 208, 225, 0.4);
            border-color: #4dd0e1;
        }

        /* Equals button - green */
        .btn-equals {
            color: #00ff88;
            font-weight: 700;
            border-color: #00ff8855;
            background: #0a1520;
        }

        .btn-equals:hover {
            background: #122030;
            border-color: #00ff88;
        }

        .btn-equals:active {
            transform: scale(0.95);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.7), 0 0 50px rgba(0, 255, 136, 0.5);
            border-color: #00ff88;
        }

        .btn-wide {
            grid-column: span 2;
        }

        .bottom-nav {
            display: flex;
            margin-top: 15px;
            background: #050a10;
            border-radius: 10px;
            padding: 5px;
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 10px;
            background: transparent;
            border: none;
            color: #5a7a9a;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.65rem;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .nav-btn.active {
            background: #0a1520;
            color: #00e5ff;
        }

        .nav-btn:hover:not(.active) {
            color: #8aa0b8;
        }

        .nav-icon {
            font-size: 1.2rem;
        }

        .nav-indicator {
            width: 20px;
            height: 2px;
            background: #00e5ff;
            border-radius: 1px;
            margin-top: 2px;
        }

        .sci-panel {
            margin-bottom: 8px;
        }

        .sci-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 6px;
        }

        .sci-buttons .btn {
            padding: 10px 6px;
            font-size: 0.85rem;
        }

        /* Converter Styles */
        .converter-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .converter-title {
            color: #00e5ff;
            font-size: 0.9rem;
            text-align: center;
            margin-bottom: 5px;
        }

        .converter-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .converter-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .converter-input {
            flex: 1;
            background: #050a10;
            border: 1px solid #3a4a6a;
            border-radius: 8px;
            padding: 15px;
            color: #00ff88;
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.2rem;
            text-align: right;
        }

        .converter-input:focus {
            outline: none;
            border-color: #00e5ff;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.4);
        }

        /* Custom Dropdown Styling */
        .custom-select-wrapper {
            position: relative;
            width: 100px;
            min-width: 100px;
        }

        /* Wider for unit converter */
        .converter-input-group .custom-select-wrapper {
            width: 120px;
        }

        .custom-select-trigger {
            width: 100%;
            background: linear-gradient(180deg, #0a1520 0%, #080f18 100%);
            border: 1px solid #ffa72666;
            border-radius: 8px;
            padding: 15px 30px 15px 10px;
            color: #ffb74d;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            text-shadow: 0 0 10px rgba(255, 167, 38, 0.5);
            user-select: none;
            position: relative;
        }

        .custom-select-trigger::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 6px solid #ffa726;
            transition: transform 0.2s ease;
        }

        .custom-select-trigger.open::after {
            transform: translateY(-50%) rotate(180deg);
        }

        .custom-select-trigger:hover {
            border-color: #ffa726;
            box-shadow: 0 0 15px rgba(255, 167, 38, 0.3);
            background: linear-gradient(180deg, #0d1824 0%, #0a1520 100%);
        }

        .custom-select-options {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            right: 0;
            background: linear-gradient(180deg, #0d1520 0%, #0a1018 100%);
            border: 1px solid #ffa726;
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 0 30px rgba(255, 167, 38, 0.4), 0 0 50px rgba(0, 229, 255, 0.2);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .custom-select-options.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .custom-select-options::-webkit-scrollbar {
            width: 8px;
        }

        .custom-select-options::-webkit-scrollbar-track {
            background: #050a10;
            border-radius: 4px;
        }

        .custom-select-options::-webkit-scrollbar-thumb {
            background: #ffa726;
            border-radius: 4px;
        }

        .custom-select-options::-webkit-scrollbar-thumb:hover {
            background: #ffb74d;
        }

        .custom-select-option {
            padding: 12px 15px;
            color: #ffb74d;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.15s ease;
            border-bottom: 1px solid #1a2530;
            text-align: center;
        }

        .custom-select-option:last-child {
            border-bottom: none;
        }

        .custom-select-option:hover {
            background: linear-gradient(90deg, #122030 0%, #0d1824 100%);
            color: #ffa726;
            text-shadow: 0 0 15px rgba(255, 167, 38, 0.6);
            box-shadow: inset 0 0 20px rgba(255, 167, 38, 0.1);
        }

        .custom-select-option.selected {
            background: linear-gradient(90deg, #1a2530 0%, #0d1520 100%);
            color: #ffa726;
            font-weight: 700;
            text-shadow: 0 0 15px rgba(255, 167, 38, 0.8);
        }

        /* Fallback for native select (hidden) */
        .currency-select {
            display: none;
        }

        .swap-btn {
            background: #0a1520;
            border: 1px solid #ff408166;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: #ff4081;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            align-self: center;
        }

        .swap-btn:hover {
            background: #122030;
            border-color: #ff4081;
        }

        .swap-btn:active {
            transform: scale(0.95);
            box-shadow: 0 0 30px rgba(255, 64, 129, 0.7), 0 0 50px rgba(255, 64, 129, 0.5);
        }

        .rate-info {
            text-align: center;
            color: #5a7a9a;
            font-size: 0.75rem;
            font-family: 'Share Tech Mono', monospace;
        }

        .currency-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .currency-btn {
            padding: 12px 8px;
            background: #0a1520;
            border: 1px solid #3a4a6a;
            border-radius: 8px;
            color: #e0e0e0;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .currency-btn:hover {
            background: #122030;
            border-color: #5a6a8a;
        }

        .currency-btn:active {
            transform: scale(0.95);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.5);
        }

        .currency-btn.active {
            border-color: #00e5ff;
            color: #00e5ff;
        }

        .currency-btn.crypto {
            color: #ffb74d;
            border-color: #ffa72655;
        }

        .currency-btn.crypto:hover {
            border-color: #ffa726;
        }

        .currency-btn.crypto:active {
            box-shadow: 0 0 25px rgba(255, 167, 38, 0.6);
        }

        .currency-btn.crypto.active {
            border-color: #ffa726;
            color: #ffa726;
        }

        .unit-categories {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .category-btn {
            padding: 12px 8px;
            background: #0a1520;
            border: 1px solid #3a4a6a;
            border-radius: 8px;
            color: #e0e0e0;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .category-btn:hover {
            background: #122030;
            border-color: #5a6a8a;
        }

        .category-btn:active {
            transform: scale(0.95);
            box-shadow: 0 0 25px rgba(0, 229, 255, 0.5);
        }

        .category-btn.active {
            border-color: #00e5ff;
            color: #00e5ff;
        }

        .unit-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .unit-btn {
            padding: 10px 6px;
            background: #0a1520;
            border: 1px solid #3a4a6a;
            border-radius: 8px;
            color: #e0e0e0;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .unit-btn:hover {
            background: #122030;
            border-color: #5a6a8a;
        }

        .unit-btn:active {
            transform: scale(0.95);
            box-shadow: 0 0 25px rgba(255, 167, 38, 0.5);
        }

        .unit-btn.active {
            border-color: #ffa726;
            color: #ffa726;
        }

        .section-label {
            color: #5a7a9a;
            font-size: 0.65rem;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .error {
            color: #ff5252 !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useEffect, useRef } = React;

        // Custom Select Component
        function CustomSelect({ value, onChange, options }) {
            const [isOpen, setIsOpen] = useState(false);
            const wrapperRef = useRef(null);

            // Close dropdown when clicking outside
            useEffect(() => {
                function handleClickOutside(event) {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                }
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            return (
                <div className="custom-select-wrapper" ref={wrapperRef}>
                    <div
                        className={`custom-select-trigger ${isOpen ? 'open' : ''}`}
                        onClick={() => setIsOpen(!isOpen)}
                    >
                        {value}
                    </div>
                    <div className={`custom-select-options ${isOpen ? 'open' : ''}`}>
                        {options.map(option => (
                            <div
                                key={option}
                                className={`custom-select-option ${option === value ? 'selected' : ''}`}
                                onClick={() => {
                                    onChange(option);
                                    setIsOpen(false);
                                }}
                            >
                                {option}
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // Initial exchange rates (USD base) - will be updated with real-time data
        const initialExchangeRates = {
            USD: 1, EUR: 0.92, GBP: 0.79, JPY: 149.50, CNY: 7.24,
            CHF: 0.88, CAD: 1.36, AUD: 1.53, INR: 83.12, KRW: 1320.50,
            BTC: 95000, ETH: 3300, SOL: 140, XRP: 2.14,
        };

        // Unit conversion data
        const unitCategories = {
            length: {
                name: 'Length',
                units: {
                    m: { name: 'Meters', factor: 1 },
                    km: { name: 'Kilometers', factor: 0.001 },
                    cm: { name: 'Centimeters', factor: 100 },
                    mm: { name: 'Millimeters', factor: 1000 },
                    mi: { name: 'Miles', factor: 0.000621371 },
                    yd: { name: 'Yards', factor: 1.09361 },
                    ft: { name: 'Feet', factor: 3.28084 },
                    in: { name: 'Inches', factor: 39.3701 },
                }
            },
            weight: {
                name: 'Weight',
                units: {
                    kg: { name: 'Kilograms', factor: 1 },
                    g: { name: 'Grams', factor: 1000 },
                    mg: { name: 'Milligrams', factor: 1000000 },
                    lb: { name: 'Pounds', factor: 2.20462 },
                    oz: { name: 'Ounces', factor: 35.274 },
                    t: { name: 'Tonnes', factor: 0.001 },
                }
            },
            temp: {
                name: 'Temp',
                units: {
                    c: { name: 'Celsius' },
                    f: { name: 'Fahrenheit' },
                    k: { name: 'Kelvin' },
                }
            },
            volume: {
                name: 'Volume',
                units: {
                    l: { name: 'Liters', factor: 1 },
                    ml: { name: 'Milliliters', factor: 1000 },
                    gal: { name: 'Gallons', factor: 0.264172 },
                    qt: { name: 'Quarts', factor: 1.05669 },
                    pt: { name: 'Pints', factor: 2.11338 },
                    cup: { name: 'Cups', factor: 4.22675 },
                }
            },
            area: {
                name: 'Area',
                units: {
                    m2: { name: 'm²', factor: 1 },
                    km2: { name: 'km²', factor: 0.000001 },
                    ft2: { name: 'ft²', factor: 10.7639 },
                    ac: { name: 'Acres', factor: 0.000247105 },
                    ha: { name: 'Hectares', factor: 0.0001 },
                }
            },
            speed: {
                name: 'Speed',
                units: {
                    ms: { name: 'm/s', factor: 1 },
                    kmh: { name: 'km/h', factor: 3.6 },
                    mph: { name: 'mph', factor: 2.23694 },
                    kn: { name: 'Knots', factor: 1.94384 },
                }
            },
        };

        function Calculator() {
            const [expression, setExpression] = useState('');
            const [result, setResult] = useState('0');
            const [isScientific, setIsScientific] = useState(true);
            const [memory, setMemory] = useState(0);
            const [lastResult, setLastResult] = useState(0);
            const [activeTab, setActiveTab] = useState('calc');
            const [hasError, setHasError] = useState(false);
            const [showingResult, setShowingResult] = useState(false);
            const [lastExpression, setLastExpression] = useState('');

            // Currency converter state
            const [fromCurrency, setFromCurrency] = useState('USD');
            const [toCurrency, setToCurrency] = useState('EUR');
            const [currencyAmount, setCurrencyAmount] = useState('1');
            const [convertedAmount, setConvertedAmount] = useState('');
            const [exchangeRates, setExchangeRates] = useState(initialExchangeRates);
            const [ratesLoading, setRatesLoading] = useState(false);
            const [lastUpdated, setLastUpdated] = useState(null);

            // Unit converter state
            const [unitCategory, setUnitCategory] = useState('length');
            const [fromUnit, setFromUnit] = useState('m');
            const [toUnit, setToUnit] = useState('ft');
            const [unitAmount, setUnitAmount] = useState('1');
            const [convertedUnit, setConvertedUnit] = useState('');

            // Evaluate expression safely
            const evaluateExpression = (expr) => {
                try {
                    // Replace display symbols with JS operators
                    let jsExpr = expr
                        .replace(/×/g, '*')
                        .replace(/÷/g, '/')
                        .replace(/−/g, '-')
                        .replace(/π/g, `(${Math.PI})`)
                        .replace(/e(?![x])/g, `(${Math.E})`)
                        .replace(/\^/g, '**')
                        .replace(/sin\(/g, 'Math.sin(')
                        .replace(/cos\(/g, 'Math.cos(')
                        .replace(/tan\(/g, 'Math.tan(')
                        .replace(/log\(/g, 'Math.log10(')
                        .replace(/ln\(/g, 'Math.log(')
                        .replace(/√\(/g, 'Math.sqrt(')
                        .replace(/abs\(/g, 'Math.abs(');

                    // Check for incomplete expression
                    if (/[+\-*/^(]$/.test(jsExpr.trim())) {
                        return null;
                    }

                    // Count parentheses
                    const openCount = (jsExpr.match(/\(/g) || []).length;
                    const closeCount = (jsExpr.match(/\)/g) || []).length;

                    // Auto-close parentheses for evaluation
                    for (let i = 0; i < openCount - closeCount; i++) {
                        jsExpr += ')';
                    }

                    // Evaluate
                    const result = Function('"use strict"; return (' + jsExpr + ')')();

                    if (typeof result === 'number' && !isNaN(result)) {
                        return result;
                    }
                    return null;
                } catch (e) {
                    return null;
                }
            };

            // Result only shows after pressing equals
            useEffect(() => {
                if (expression === '') {
                    setHasError(false);
                }
            }, [expression]);

            const formatNumber = (num) => {
                if (!isFinite(num)) return num > 0 ? '∞' : '-∞';
                if (Math.abs(num) > 1e10 || (Math.abs(num) < 1e-7 && num !== 0)) {
                    return num.toExponential(6);
                }
                // Round to avoid floating point issues
                const rounded = Math.round(num * 1e10) / 1e10;
                const str = String(rounded);
                if (str.length > 12) {
                    return Number(rounded.toPrecision(10)).toString();
                }
                return str;
            };

            const appendToExpression = useCallback((value) => {
                setHasError(false);
                setShowingResult(false);
                setExpression(prev => {
                    // If previous result was shown after =, start fresh with numbers
                    if (prev === '' && /^[0-9.]$/.test(value)) {
                        setResult('0');
                        return value;
                    }
                    return prev + value;
                });
            }, []);

            const handleNumber = useCallback((num) => {
                appendToExpression(num);
            }, [appendToExpression]);

            const handleDecimal = useCallback(() => {
                setExpression(prev => {
                    // Find the last number in expression
                    const parts = prev.split(/[+\-×÷^(]/);
                    const lastPart = parts[parts.length - 1];
                    if (lastPart.includes('.')) return prev;
                    return prev + '.';
                });
            }, []);

            const handleOperator = useCallback((op) => {
                setExpression(prev => {
                    if (prev === '') return '';
                    // Replace last operator if needed
                    if (/[+\-×÷^]$/.test(prev)) {
                        return prev.slice(0, -1) + op;
                    }
                    return prev + op;
                });
            }, []);

            const handleFunction = useCallback((func) => {
                appendToExpression(func + '(');
            }, [appendToExpression]);

            const handleConstant = useCallback((constant) => {
                appendToExpression(constant);
            }, [appendToExpression]);

            const handleParenthesis = useCallback((paren) => {
                appendToExpression(paren);
            }, [appendToExpression]);

            const handlePower = useCallback(() => {
                appendToExpression('^');
            }, [appendToExpression]);

            const handleSquare = useCallback(() => {
                appendToExpression('^2');
            }, [appendToExpression]);

            const handleEquals = useCallback(() => {
                if (expression === '') return;

                const evaluated = evaluateExpression(expression);
                if (evaluated !== null) {
                    setLastExpression(expression);
                    setResult(formatNumber(evaluated));
                    setLastResult(evaluated);
                    setExpression('');
                    setShowingResult(true);
                    setHasError(false);
                } else {
                    setLastExpression(expression);
                    setResult('Error');
                    setExpression('');
                    setShowingResult(true);
                    setHasError(true);
                }
            }, [expression]);

            const handleClear = useCallback(() => {
                setExpression('');
                setResult('0');
                setHasError(false);
                setShowingResult(false);
            }, []);

            const handleBackspace = useCallback(() => {
                setExpression(prev => {
                    // Check for function names to delete entirely
                    const functions = ['sin(', 'cos(', 'tan(', 'log(', 'ln(', '√(', 'abs('];
                    for (const func of functions) {
                        if (prev.endsWith(func)) {
                            return prev.slice(0, -func.length);
                        }
                    }
                    return prev.slice(0, -1);
                });
            }, []);

            const handleAns = useCallback(() => {
                appendToExpression(String(lastResult));
            }, [appendToExpression, lastResult]);

            // Memory functions
            const handleMemoryClear = useCallback(() => setMemory(0), []);
            const handleMemoryRecall = useCallback(() => {
                appendToExpression(String(memory));
            }, [appendToExpression, memory]);
            const handleMemoryAdd = useCallback(() => {
                const evaluated = evaluateExpression(expression);
                if (evaluated !== null) {
                    setMemory(prev => prev + evaluated);
                }
            }, [expression]);
            const handleMemorySubtract = useCallback(() => {
                const evaluated = evaluateExpression(expression);
                if (evaluated !== null) {
                    setMemory(prev => prev - evaluated);
                }
            }, [expression]);

            // Fetch real-time exchange rates
            useEffect(() => {
                const fetchRates = async () => {
                    setRatesLoading(true);
                    try {
                        // Fetch fiat rates from exchangerate-api.com (free, no API key needed)
                        const fiatResponse = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                        const fiatData = await fiatResponse.json();

                        // Fetch crypto rates from CoinGecko (free, no API key needed, more reliable)
                        const cryptoResponse = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana,ripple&vs_currencies=usd');
                        const cryptoData = await cryptoResponse.json();

                        // Build combined rates object
                        const newRates = {
                            USD: 1,
                            EUR: fiatData.rates.EUR || initialExchangeRates.EUR,
                            GBP: fiatData.rates.GBP || initialExchangeRates.GBP,
                            JPY: fiatData.rates.JPY || initialExchangeRates.JPY,
                            CNY: fiatData.rates.CNY || initialExchangeRates.CNY,
                            CHF: fiatData.rates.CHF || initialExchangeRates.CHF,
                            CAD: fiatData.rates.CAD || initialExchangeRates.CAD,
                            AUD: fiatData.rates.AUD || initialExchangeRates.AUD,
                            INR: fiatData.rates.INR || initialExchangeRates.INR,
                            KRW: fiatData.rates.KRW || initialExchangeRates.KRW,
                        };

                        // Add crypto rates (price in USD)
                        // CoinGecko returns: { bitcoin: { usd: 95000 }, ... }
                        // The rate represents the price of 1 crypto unit in USD
                        if (cryptoData) {
                            newRates.BTC = cryptoData.bitcoin?.usd || initialExchangeRates.BTC;
                            newRates.ETH = cryptoData.ethereum?.usd || initialExchangeRates.ETH;
                            newRates.SOL = cryptoData.solana?.usd || initialExchangeRates.SOL;
                            newRates.XRP = cryptoData.ripple?.usd || initialExchangeRates.XRP;
                        }

                        console.log('Fetched rates:', newRates); // Debug log
                        setExchangeRates(newRates);
                        setLastUpdated(new Date());
                    } catch (error) {
                        console.error('Failed to fetch rates:', error);
                        // Keep using initial rates on error
                    } finally {
                        setRatesLoading(false);
                    }
                };

                // Fetch rates on mount and when switching to currency tab
                if (activeTab === 'conv') {
                    fetchRates();
                }
            }, [activeTab]);

            // Currency conversion
            useEffect(() => {
                const amount = parseFloat(currencyAmount) || 0;
                const cryptoCurrencies = ['BTC', 'ETH', 'SOL', 'XRP'];

                const fromRate = exchangeRates[fromCurrency];
                const toRate = exchangeRates[toCurrency];

                // Direct conversion without intermediate USD step
                let result;

                const fromIsCrypto = cryptoCurrencies.includes(fromCurrency);
                const toIsCrypto = cryptoCurrencies.includes(toCurrency);

                if (fromIsCrypto && toIsCrypto) {
                    // Crypto to Crypto: convert through USD
                    // BTC -> USD -> ETH
                    result = (amount * fromRate) / toRate;
                } else if (fromIsCrypto && !toIsCrypto) {
                    // Crypto to Fiat: BTC -> USD -> EUR
                    // 1 BTC = $95000, 1 USD = 0.92 EUR
                    // So 1 BTC = 95000 * 0.92 EUR
                    result = (amount * fromRate) * toRate;
                } else if (!fromIsCrypto && toIsCrypto) {
                    // Fiat to Crypto: EUR -> USD -> BTC
                    // 1 EUR = 1/0.92 USD, then USD to BTC
                    result = (amount / fromRate) / toRate;
                } else {
                    // Fiat to Fiat: EUR -> USD -> GBP
                    // 1 EUR = 1/0.92 USD, 1 USD = 0.79 GBP
                    // So: (amount / fromRate) * toRate
                    result = (amount / fromRate) * toRate;
                }

                setConvertedAmount(result.toFixed(toCurrency === 'BTC' ? 8 : toCurrency === 'ETH' || toCurrency === 'SOL' ? 6 : 2));
            }, [currencyAmount, fromCurrency, toCurrency, exchangeRates]);

            const swapCurrencies = () => {
                setFromCurrency(toCurrency);
                setToCurrency(fromCurrency);
            };

            // Unit conversion
            useEffect(() => {
                const amount = parseFloat(unitAmount) || 0;
                const category = unitCategories[unitCategory];

                if (unitCategory === 'temp') {
                    let celsius;
                    switch(fromUnit) {
                        case 'c': celsius = amount; break;
                        case 'f': celsius = (amount - 32) * 5/9; break;
                        case 'k': celsius = amount - 273.15; break;
                        default: celsius = amount;
                    }
                    let result;
                    switch(toUnit) {
                        case 'c': result = celsius; break;
                        case 'f': result = celsius * 9/5 + 32; break;
                        case 'k': result = celsius + 273.15; break;
                        default: result = celsius;
                    }
                    setConvertedUnit(result.toFixed(2));
                } else {
                    const fromFactor = category.units[fromUnit]?.factor || 1;
                    const toFactor = category.units[toUnit]?.factor || 1;
                    const baseValue = amount / fromFactor;
                    const result = baseValue * toFactor;
                    setConvertedUnit(result.toFixed(6).replace(/\.?0+$/, ''));
                }
            }, [unitAmount, fromUnit, toUnit, unitCategory]);

            useEffect(() => {
                const units = Object.keys(unitCategories[unitCategory].units);
                setFromUnit(units[0]);
                setToUnit(units[1] || units[0]);
            }, [unitCategory]);

            const swapUnits = () => {
                setFromUnit(toUnit);
                setToUnit(fromUnit);
            };

            const fiatCurrencies = ['USD', 'EUR', 'GBP', 'JPY', 'CNY', 'CHF', 'CAD', 'AUD', 'INR', 'KRW'];
            const cryptoCurrencies = ['BTC', 'ETH', 'SOL', 'XRP'];

            return (
                <div className="calculator-wrapper">
                    <div className="calculator">
                        {/* Header */}
                        <div className="header">
                            <div className="traffic-lights">
                                <div className="traffic-light red"></div>
                                <div className="traffic-light yellow"></div>
                                <div className="traffic-light green"></div>
                            </div>
                            {activeTab === 'calc' && (
                                <div className="mode-toggle">
                                    <span className={`mode-label ${!isScientific ? 'active' : ''}`}>BASIC</span>
                                    <div className="toggle-switch" onClick={() => setIsScientific(!isScientific)}>
                                        <div className={`toggle-knob ${isScientific ? 'sci' : 'basic'}`}></div>
                                    </div>
                                    <span className={`mode-label ${isScientific ? 'active' : ''}`}>SCI</span>
                                </div>
                            )}
                            {activeTab === 'conv' && <div className="converter-title">CURRENCY</div>}
                            {activeTab === 'unit' && <div className="converter-title">UNITS</div>}
                        </div>

                        {/* Calculator Tab */}
                        {activeTab === 'calc' && (
                            <>
                                <div className="display-container">
                                    <div className="corner-bl"></div>
                                    <div className="corner-br"></div>
                                    <div className="expression">
                                        {showingResult ? lastExpression : '\u00A0'}
                                    </div>
                                    <div className={`display ${hasError ? 'error' : ''}`}>
                                        {showingResult ? result : (expression || '0')}
                                        {!showingResult && expression && <span className="cursor">|</span>}
                                    </div>
                                </div>

                                {isScientific && (
                                    <div className="sci-panel">
                                        <div className="sci-buttons">
                                            <button className="btn btn-memory" onClick={handleMemoryClear}>MC</button>
                                            <button className="btn btn-memory" onClick={handleMemoryRecall}>MR</button>
                                            <button className="btn btn-memory" onClick={handleMemoryAdd}>M+</button>
                                            <button className="btn btn-memory" onClick={handleMemorySubtract}>M−</button>
                                        </div>
                                        <div className="sci-buttons">
                                            <button className="btn btn-function" onClick={() => handleFunction('sin')}>sin</button>
                                            <button className="btn btn-function" onClick={() => handleFunction('cos')}>cos</button>
                                            <button className="btn btn-function" onClick={() => handleFunction('tan')}>tan</button>
                                            <button className="btn btn-function" onClick={() => handleFunction('log')}>log</button>
                                        </div>
                                        <div className="sci-buttons">
                                            <button className="btn btn-function" onClick={() => handleFunction('ln')}>ln</button>
                                            <button className="btn btn-function" onClick={() => handleFunction('√')}>√</button>
                                            <button className="btn btn-function" onClick={handleSquare}>x²</button>
                                            <button className="btn btn-function" onClick={handlePower}>xʸ</button>
                                        </div>
                                        <div className="sci-buttons">
                                            <button className="btn btn-function" onClick={() => handleConstant('π')}>π</button>
                                            <button className="btn btn-function" onClick={() => handleConstant('e')}>e</button>
                                            <button className="btn btn-function" onClick={() => handleParenthesis('(')}>(</button>
                                            <button className="btn btn-function" onClick={() => handleParenthesis(')')}>)</button>
                                        </div>
                                    </div>
                                )}

                                <div className="buttons">
                                    <button className="btn btn-clear" onClick={handleClear}>AC</button>
                                    <button className="btn btn-clear" onClick={handleBackspace}>⌫</button>
                                    <button className="btn btn-ans" onClick={handleAns}>ANS</button>
                                    <button className="btn btn-operator" onClick={() => handleOperator('÷')}>÷</button>

                                    <button className="btn btn-number" onClick={() => handleNumber('7')}>7</button>
                                    <button className="btn btn-number" onClick={() => handleNumber('8')}>8</button>
                                    <button className="btn btn-number" onClick={() => handleNumber('9')}>9</button>
                                    <button className="btn btn-operator" onClick={() => handleOperator('×')}>×</button>

                                    <button className="btn btn-number" onClick={() => handleNumber('4')}>4</button>
                                    <button className="btn btn-number" onClick={() => handleNumber('5')}>5</button>
                                    <button className="btn btn-number" onClick={() => handleNumber('6')}>6</button>
                                    <button className="btn btn-operator" onClick={() => handleOperator('−')}>−</button>

                                    <button className="btn btn-number" onClick={() => handleNumber('1')}>1</button>
                                    <button className="btn btn-number" onClick={() => handleNumber('2')}>2</button>
                                    <button className="btn btn-number" onClick={() => handleNumber('3')}>3</button>
                                    <button className="btn btn-operator" onClick={() => handleOperator('+')}>+</button>

                                    <button className="btn btn-number btn-wide" onClick={() => handleNumber('0')}>0</button>
                                    <button className="btn btn-number" onClick={handleDecimal}>.</button>
                                    <button className="btn btn-equals" onClick={handleEquals}>=</button>
                                </div>
                            </>
                        )}

                        {/* Currency Converter Tab */}
                        {activeTab === 'conv' && (
                            <div className="converter-panel">
                                <div className="converter-row">
                                    <div className="section-label">From</div>
                                    <div className="converter-input-group">
                                        <input
                                            type="number"
                                            className="converter-input"
                                            value={currencyAmount}
                                            onChange={(e) => setCurrencyAmount(e.target.value)}
                                        />
                                        <CustomSelect
                                            value={fromCurrency}
                                            onChange={setFromCurrency}
                                            options={[...fiatCurrencies, ...cryptoCurrencies]}
                                        />
                                    </div>
                                </div>

                                <button className="swap-btn" onClick={swapCurrencies}>⇅</button>

                                <div className="converter-row">
                                    <div className="section-label">To</div>
                                    <div className="converter-input-group">
                                        <input
                                            type="text"
                                            className="converter-input"
                                            value={convertedAmount}
                                            readOnly
                                        />
                                        <CustomSelect
                                            value={toCurrency}
                                            onChange={setToCurrency}
                                            options={[...fiatCurrencies, ...cryptoCurrencies]}
                                        />
                                    </div>
                                </div>

                                <div className="rate-info">
                                    {ratesLoading ? (
                                        <span style={{color: '#00e5ff'}}>⟳ Updating rates...</span>
                                    ) : (
                                        <>
                                            {(() => {
                                                const cryptoCurrencies = ['BTC', 'ETH', 'SOL', 'XRP'];
                                                const fromRate = exchangeRates[fromCurrency];
                                                const toRate = exchangeRates[toCurrency];

                                                const fromIsCrypto = cryptoCurrencies.includes(fromCurrency);
                                                const toIsCrypto = cryptoCurrencies.includes(toCurrency);

                                                let result;

                                                if (fromIsCrypto && toIsCrypto) {
                                                    result = fromRate / toRate;
                                                } else if (fromIsCrypto && !toIsCrypto) {
                                                    result = fromRate * toRate;
                                                } else if (!fromIsCrypto && toIsCrypto) {
                                                    result = (1 / fromRate) / toRate;
                                                } else {
                                                    result = (1 / fromRate) * toRate;
                                                }

                                                return `1 ${fromCurrency} = ${result.toFixed(
                                                    toCurrency === 'BTC' ? 8 : toCurrency === 'ETH' || toCurrency === 'SOL' ? 6 : 4
                                                )} ${toCurrency}`;
                                            })()}
                                            {lastUpdated && (
                                                <div style={{marginTop: '5px', fontSize: '0.65rem', color: '#00ff88'}}>
                                                    ✓ Live rates • {lastUpdated.toLocaleTimeString()}
                                                </div>
                                            )}
                                        </>
                                    )}
                                </div>

                                <div className="section-label" style={{marginTop: '15px'}}>Fiat Currencies</div>
                                <div className="currency-grid">
                                    {fiatCurrencies.map(c => (
                                        <button
                                            key={c}
                                            className={`currency-btn ${fromCurrency === c ? 'active' : ''}`}
                                            onClick={() => setFromCurrency(c)}
                                        >
                                            {c}
                                        </button>
                                    ))}
                                </div>

                                <div className="section-label" style={{marginTop: '10px'}}>Crypto</div>
                                <div className="currency-grid">
                                    {cryptoCurrencies.map(c => (
                                        <button
                                            key={c}
                                            className={`currency-btn crypto ${fromCurrency === c ? 'active' : ''}`}
                                            onClick={() => setFromCurrency(c)}
                                        >
                                            {c}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Unit Converter Tab */}
                        {activeTab === 'unit' && (
                            <div className="converter-panel">
                                <div className="unit-categories">
                                    {Object.entries(unitCategories).map(([key, cat]) => (
                                        <button
                                            key={key}
                                            className={`category-btn ${unitCategory === key ? 'active' : ''}`}
                                            onClick={() => setUnitCategory(key)}
                                        >
                                            {cat.name}
                                        </button>
                                    ))}
                                </div>

                                <div className="converter-row">
                                    <div className="section-label">From</div>
                                    <div className="converter-input-group">
                                        <input
                                            type="number"
                                            className="converter-input"
                                            value={unitAmount}
                                            onChange={(e) => setUnitAmount(e.target.value)}
                                        />
                                        <CustomSelect
                                            value={unitCategories[unitCategory].units[fromUnit].name}
                                            onChange={(name) => {
                                                const key = Object.entries(unitCategories[unitCategory].units)
                                                    .find(([k, u]) => u.name === name)?.[0];
                                                if (key) setFromUnit(key);
                                            }}
                                            options={Object.values(unitCategories[unitCategory].units).map(u => u.name)}
                                        />
                                    </div>
                                </div>

                                <button className="swap-btn" onClick={swapUnits}>⇅</button>

                                <div className="converter-row">
                                    <div className="section-label">To</div>
                                    <div className="converter-input-group">
                                        <input
                                            type="text"
                                            className="converter-input"
                                            value={convertedUnit}
                                            readOnly
                                        />
                                        <CustomSelect
                                            value={unitCategories[unitCategory].units[toUnit].name}
                                            onChange={(name) => {
                                                const key = Object.entries(unitCategories[unitCategory].units)
                                                    .find(([k, u]) => u.name === name)?.[0];
                                                if (key) setToUnit(key);
                                            }}
                                            options={Object.values(unitCategories[unitCategory].units).map(u => u.name)}
                                        />
                                    </div>
                                </div>

                                <div className="section-label" style={{marginTop: '15px'}}>Quick Select</div>
                                <div className="unit-grid">
                                    {Object.entries(unitCategories[unitCategory].units).map(([key, unit]) => (
                                        <button
                                            key={key}
                                            className={`unit-btn ${fromUnit === key || toUnit === key ? 'active' : ''}`}
                                            onClick={() => setFromUnit(key)}
                                        >
                                            {unit.name}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Bottom Navigation */}
                        <div className="bottom-nav">
                            <button
                                className={`nav-btn ${activeTab === 'calc' ? 'active' : ''}`}
                                onClick={() => setActiveTab('calc')}
                            >
                                <span className="nav-icon">⌨</span>
                                <span>CALC</span>
                                {activeTab === 'calc' && <div className="nav-indicator"></div>}
                            </button>
                            <button
                                className={`nav-btn ${activeTab === 'conv' ? 'active' : ''}`}
                                onClick={() => setActiveTab('conv')}
                            >
                                <span className="nav-icon">$</span>
                                <span>CONV</span>
                                {activeTab === 'conv' && <div className="nav-indicator"></div>}
                            </button>
                            <button
                                className={`nav-btn ${activeTab === 'unit' ? 'active' : ''}`}
                                onClick={() => setActiveTab('unit')}
                            >
                                <span className="nav-icon">⚖</span>
                                <span>UNITS</span>
                                {activeTab === 'unit' && <div className="nav-indicator"></div>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<Calculator />);
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registration successful:', registration.scope);
                    })
                    .catch((err) => {
                        console.log('ServiceWorker registration failed:', err);
                    });
            });
        }
    </script>
</body>
</html>
